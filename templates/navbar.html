<!-- üåê Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-info" href="/">‚öôÔ∏è ESP32-S3 DC MOTOR CONTROLLER</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/">Main Page</a></li>
        <li class="nav-item"><a class="nav-link" href="/log_function_execution">Log</a></li>
        <li class="nav-item"><a class="nav-link" href="/fan">Fan</a></li>
        <li class="nav-item"><a class="nav-link" href="/wifi">WiFi Info</a></li>
        <li class="nav-item"><a class="nav-link" href="/log_page">System Info</a></li>
        <li class="nav-item"><a class="nav-link" href="/login.html" id="authLink">üîê Login</a></li>
        <li class="nav-item"><a class="nav-link" href="/settings">System Settings</a></li>
        <li class="nav-item"><a class="nav-link" href="/firmware_update">Firmware</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- üì¢ Modal global -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow rounded-4">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="feedbackLabel">‚ÑπÔ∏è ESP Notification</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="feedbackBody"></div>

        <!-- Slider (shown only if URL provided) -->
        <div id="speedWrapper" class="mt-3 d-none">
          <label for="manualSpeedInput" class="form-label">Manual speed (%)</label>
          <input id="manualSpeedInput" type="range" min="0" max="100" step="1" class="form-range">
          <div><span id="manualSpeedValue">0</span>%</div>
        </div>
      </div>

      <div class="modal-footer" id="feedbackFooter"></div>
    </div>
  </div>
</div>

<!-- ‚òï + üí≥ Floating Donate Buttons -->
<div id="donate-float-container">
  <a href="https://buymeacoffee.com/devbmv"
     target="_blank"
     rel="noopener noreferrer"
     class="btn btn-warning rounded-circle shadow-lg"
     title="‚òï Support this project via Buy Me a Coffee">
     ‚òï
  </a>

  <a href="https://revolut.me/mihailuf6d"
     target="_blank"
     rel="noopener noreferrer"
     class="btn btn-success rounded-circle shadow-lg"
     title="üí≥ Donate securely via Revolut (no fees)">
     üí≥
  </a>
</div>


<style>
  #donate-float-container {
    position: fixed;
    bottom: 22px;
    right: 22px;
    display: flex;
    gap: 10px;
    z-index: 1050;
  }

  #donate-float-container a {
    width: 58px;
    height: 58px;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  #donate-float-container a:hover {
    transform: scale(1.1);
    box-shadow: 0 0 18px rgba(255, 193, 7, 0.7);
  }
</style>

<script>
  // üåô Dark Mode toggle
  const toggleBtn = document.getElementById('toggleDarkMode');
  if (localStorage.getItem('dark-mode') === 'true') {
    document.body.classList.add('dark-mode');
  }
  toggleBtn?.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('dark-mode', document.body.classList.contains('dark-mode'));
  });

  // üöÄ Initialize Bootstrap UI + Navbar Behavior
  document.addEventListener('DOMContentLoaded', () => {
    // Activate tooltips & popovers
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
    document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => new bootstrap.Popover(el));

    // üîª Auto-close navbar on link click (for mobile)
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
      link.addEventListener('click', () => {
        const navbar = document.getElementById('navbarNavDropdown');
        const bsCollapse = bootstrap.Collapse.getInstance(navbar);
        if (bsCollapse) bsCollapse.hide();
      });
    });
  });

  // üîê Login / Logout
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  const authLink = document.getElementById('authLink');
  const session = getCookie('ESPSESSION');
  if (session) {
    authLink.textContent = "üö™ Logout";
    authLink.href = "#";
    authLink.addEventListener('click', function (e) {
      e.preventDefault();
      fetch('/logout', { method: 'POST' })
        .then(() => {
          document.cookie = "ESPSESSION=; Path=/; Max-Age=0";
          window.location.href = '/login.html';
        })
        .catch(() => showModal("Logout failed!", false));
    });
  }

  // üì¢ Global modal display
  function showModal(message, success = true) {
    const body = document.getElementById('feedbackBody');
    const header = document.getElementById('feedbackLabel');
    if (body) body.innerHTML = message;
    if (header) header.textContent = success ? "‚úÖ Success" : "‚ùå Error";

    const modalEl = document.getElementById('feedbackModal');
    if (modalEl) {
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }
  }
</script>
